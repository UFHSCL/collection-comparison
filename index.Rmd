---
title: "HSCL Peer Institution Collection Comparison"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: spacelab
    social: menu
    source_code: https://github.com/ufhscl/collection-comparison/index.Rmd
---

```{r setup, include = FALSE}
library(highcharter)
library(tidyverse)
library(DT)

collections_data <- readRDS("collections_data.Rdata")
```

```{r}
rank_data <- collections_data %>% 
  count(resource) %>%
  arrange(desc(n)) %>%
  mutate(rank = row_number()) %>%
  select(!n)

summary_count <- collections_data %>%
    count(resource, region) %>%
    complete(resource, region, fill = list(n = 0)) %>%
    left_join(rank_data) %>%
    arrange(rank)

summary_florida <- collections_data %>%
  filter(region == "Florida") %>%
  count(resource) %>%
  left_join(rank_data) %>%
  arrange(desc(n))

resource_data <- collections_data %>%
  select(!one_of("school", "code", "region")) %>%
  distinct()

peer_data <- collections_data %>%
  group_by(school) %>%
  summarize(num_resources = n(), 
            resources = list(resource)) %>%
  left_join(distinct(select(collections_data, school, region))) %>%
  select(school, region, num_resources, resources) %>%
  arrange(desc(num_resources))

resource_info <- summary_count %>%
  pivot_wider(names_from = region, values_from = n) %>%
  left_join(resource_data) %>%
  mutate("Total peers with" = Florida + US, 
         "Florida peers with" = Florida, 
         "US peers with" = US) %>%
  select(!one_of("Florida", "US", "rank")) %>%
  select(resource, "Total peers with", "Florida peers with", "US peers with", everything())
```



Resources (most owned by peers)
===================================== 

Column {data-width=800}
-----------------------------------------------------------------------

# TODO
# Re-organize plots into the following tabs
# - tab for Florida peers (without backfiles)
# - tab for US peers (without backfiles)
# - all peers (without backfiles)
# - all peers, all resources
#
# Check for display of names (currently showing all bars, but labels are cut off)
# - using different plotting interface (hover-over annotation?)

### Resources by Peer Institution

```{r}
hchart(summary_count, "bar", hcaes(x = resource, y = n, 
                                  group = region)) %>%
    hc_plotOptions(series = list(
        stacking = "normal")
    ) %>%
    hc_xAxis(title = list(
        text = "Resource")
    ) %>%
    hc_yAxis(title = list(
        text = "Number of Peer Institutions")
    )
```

Resources (Florida-only)
===================================== 

Column {data-width=800}
-----------------------------------------------------------------------

### Resources by Peer Institution

```{r}
hchart(summary_florida, "bar", hcaes(x = resource, y = n)) %>%
    hc_plotOptions(series = list(
        stacking = "normal")
    ) %>%
    hc_xAxis(title = list(
        text = "Resource")
    ) %>%
    hc_yAxis(title = list(
        text = "Number of Peer Institutions")
    )
```

Peer Data
=====================================

Column {data-width=800}
-----------------------------------------------------------------------

```{r}
datatable(peer_data, 
          rownames = FALSE, 
          options = list(pageLength = NROW(peer_data), 
                         scrollY = "800px"))
```



Resource Data 
===================================== 

Column {data-width=800}
-----------------------------------------------------------------------

```{r}
datatable(resource_info, 
          rownames = FALSE, 
          options = list(pageLength = NROW(resource_info), 
                         scrollY = "800px"))
```


